---
title: "water-temp-bc"
output:
  html_document:
    code_folding: hide
    self_contained: true
params: 
  rmd_on: FALSE
---

```{r setup, echo=FALSE, include = TRUE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE, dpi=60, out.width = "100%")

```


```{r, echo=FALSE, include = T}

staticimports::import()
source('scripts/staticimports.R')
source('scripts/functions.R')
```



```{r build, echo= FALSE, eval = FALSE}
rmarkdown::render(
  "README.Rmd", 
  output_format = "github_document", 
  params = list(rmd_on = FALSE)
  )

rmarkdown::render(
  "README.Rmd", 
  output_format = "html_document", 
  output_file = "index.html", 
  params = list(rmd_on = TRUE)
  )

usethis::use_git_ignore("README.html")
```

<!-- README.md is generated from README.Rmd. Please edit that file -->


![neeTo](https://img.shields.io/badge/status-neeTo-green)
![dEce](https://img.shields.io/badge/plays-dEce-red)

The goal of `water-temp-bc` is to document and serve out water temperature data. Setup and wrangle scripts are located here https://github.com/NewGraphEnvironment/water-temp-bc .  Using [`duckdb`](https://github.com/duckdb/duckdb-r) for `R` we are able to connect directly to a parquet file stored on a S3 bucket and query around to explore the provincial realtime data for the province of British Columbia.

<br>


```{r fig, echo=FALSE, out.width="100%", fig.align="center", eval = TRUE}

fpr::fpr_photo_resize_convert("fig/cover.png", path = "fig")
knitr::include_graphics("fig/cover.JPG")
```

<br>

In the code chunks below we connect to duckdb load the `httpfs` extension.

`r if (params$rmd_on == FALSE) "Please see http://www.newgraphenvironment.com/water-temp-bc for published table of collection links/details."`

```{r connect, results="asis", eval=TRUE}
con <- DBI::dbConnect(duckdb::duckdb())
DBI::dbExecute(con, "INSTALL httpfs; LOAD httpfs;")

```

<br>


In the next chunks we perform a couple of queries and present the information about the data currently available.
```{r stations-query}
tab <- DBI::dbGetQuery(
  con, 
  "SELECT *
  FROM 's3://water-temp-bc/data/stations_realtime.parquet'"
)
```

```{r q1}
range <- DBI::dbGetQuery(con, "
  SELECT 
    STATION_NUMBER,
    MIN(Date) AS min_date,
    MAX(Date) AS max_date
  FROM 's3://water-temp-bc/data/realtime_raw.parquet'
  WHERE Code = 'TW'
  GROUP BY STATION_NUMBER;
")
```

```{r stations-cap, echo=FALSE, results="asis", eval=identical(params$rmd_on, TRUE)}
my_caption <- "Realtime station information stored on AWS s3."

my_tab_caption_rmd()
```



```{r tab-stations, echo=FALSE, eval=identical(params$rmd_on, TRUE)}
dplyr::left_join(
  tab,
  range,
  by = "STATION_NUMBER"
  )|> 
  my_dt_table(cols_freeze_left = 2, escape = FALSE)
```

```{r q2}
tab <- DBI::dbGetQuery(con, "
  SELECT *
  FROM 's3://water-temp-bc/data/realtime_raw.parquet'
  WHERE STATION_NUMBER IN ('07EA004')
    AND Code = 'TW' 
    LIMIT 10
")
```




<br>

Below we query for data from a particular site.

<br> 


```{r tab-uav-imagery-cap, echo=FALSE, results="asis", eval=identical(params$rmd_on, TRUE)}
my_caption <- "Example of output generated by querying parquet file stored on AWS s3."

my_tab_caption_rmd()
```


```{r example, echo=FALSE, eval=identical(params$rmd_on, TRUE)}
tab |> 
  my_dt_table(cols_freeze_left = 2, escape = FALSE)
```




